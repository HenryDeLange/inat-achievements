<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>iNaturalist Achievements</title>
        <!--ReactJS-->
        <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <!--Bootstrap-->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <!--Icons-->
        <link rel="stylesheet" href="./icons/style.css">
    </head>
    <body>
<!--TODO: Kry 'n mooier header component wat verduidelik wat aangaan-->
        <div class="row">
            <div class="col">
                <hr />
                <H2 style="text-align: center; color: #2ca351">
                    Achievements
                </H2>
                <hr />
            </div>
        </div>
<!--NOTE: When using React JSX, within the <script> tags, for regular HTML tags, 
    the attribute className is used instead of class and the attribute htmlFor is used instead 
    of for attribute because these are reserved words in Javascript.-->
<!--NOTE: Inline styles are dodgy to use and the class attribute needs to be renamed to className-->        
<!--NOTE: Reusable components (can be done in different way using classes as well)-->

        <hr />
        <div id="achievementList"></div>
        <hr />
        <hr />
        <div id="rawData"></div>
        <script type="text/babel">
            // Declare the AchievementCard
            function AchievementCard(props) {
                var cardHTML =
                    <div className="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div className="card text-center border-0" style={{"margin": "2rem"}}>
                            <span className={props.icon} style={{"color": "#Bcb371", "fontSize": "6rem"}} ></span>
                            <div className="card-text">{props.title}</div>
                        </div>
                    </div>
                return cardHTML;
            }

            // Achievement variables
            var speciesCount = 0;
            var selfCommentCount = 0;
            var mammalTryhardCount = 0;
            var diggingMammals = [42478, 43253, 46927, 71384];
            var swimmingMammals = [152871, 46306];
            var flyingMammals = [40268];
            var nocturnalBirdCount = 0;
            var nocturnalBirds = [19350];
            var fishCount = 0;
            var fishes = [47178];
            var daisyCount = 0;
            var daisies = [47604];
            var endangeredCount = 0;
            var butterflyCount = 0;
            var butterlies = [47224];
            var socialCount = 0;
            var dailyObsCount = 0;
            var dailySpeciesCount = [];
            var dailyObsCountMax = 0;
            var dailySpeciesCountMax = 0;
            var dailyLifeDate = new Date().getFullYear() + "-" + new Date().getMonth() + "-" + new Date().getDate();
            var rodentCount = 0;
            var rodents = [43698];
            var storkCount = 0;
            var storks = [3726, 23];
            var bugCount = 0;
            var bugs = [61267];
            var notBugCount = 0;
            var notBugs = [144128, 47119, 47158, 243773];
            var idCount = 0;
            var projectCount = [];
            var mossCount = 0;
            var mosses = [311249, 54743];
            var toadCount = 0;
            var toads = [20979];
            var toadstoolCount = 0;
            var toadstools = [47169];
            var classCount = [];
            var flowerOrderCount = [];
            var flowers = [47125];
            var alwaysOnOneDay = 24*60*60*1000;
            var alwaysOnDate = new Date().getFullYear() + "-" + new Date().getMonth() + "-" + new Date().getDate();
            var alwaysOnCount = 0;
            var alwaysOnCountMax = 0;
            
            // Process the data
            function processDataPage(response) {
                // Process data
                var data = JSON.parse(response);
//                document.getElementById('rawData').innerHTML = response; // Lys al die data terwyl ek dev
                var arrayLength = data.results.length;
                // LOOP OVER OBSERVATIONS
                for (var i = 0; i < arrayLength; i++) {
                    var result = data.results[i];
                    // Species Count
                    if (result.taxon.rank_level <= 10) {
                        speciesCount++;
                    }
                    // Count iconic taxa
                    if (!classCount.includes(result.taxon.iconic_taxon_id)) {
                        classCount.push(result.taxon.iconic_taxon_id);
                    }
                    // Comment Checks
                    for (var c = 0; c < result.comments_count; c++) {
                        // Comments by yourself on your own observations
                        var comment = result.comments[c];
                        if (comment.user.id === result.user.id) {
                            selfCommentCount++;
                        }
                    }
                    // Count projects
                    for (var t = 0; t < result.project_ids.length; t++) {
                        if (!projectCount.includes(result.project_ids[t])) {
                            projectCount.push(result.project_ids[t]);
                        }
                    }
                    // Taxon checks
                    for (var t = 0; t < result.taxon.ancestor_ids.length; t++) {
                        var taxonID = result.taxon.ancestor_ids[t];
                        // At least one observation of a swimming, flying and digging mammal
                        if ($.inArray(taxonID, diggingMammals) >= 0 
                                || $.inArray(taxonID, swimmingMammals) >= 0 
                                || $.inArray(taxonID, flyingMammals) >= 0) {
                            mammalTryhardCount++;
                        }
                        // Number of nocturnal bird (owl) observations
                        else if ($.inArray(taxonID, nocturnalBirds) >= 0) {
                            nocturnalBirdCount++;
                        }
                        // Number of fish observations
// FIXME: Die een moet eintlik die aantal vis spesies tel wat in 'n periode (een week) aangeteken is
                        else if ($.inArray(taxonID, fishes) >= 0) {
                            fishCount++;
                        }
                        // Number of daisy observations
                        else if ($.inArray(taxonID, daisies) >= 0) {
                            daisyCount++;
                        }
                        // Number of butterfly observations
                        else if ($.inArray(taxonID, butterlies) >= 0) {
                            butterflyCount++;
                        }
                        // Number of rodent observations
                        else if ($.inArray(taxonID, rodents) >= 0) {
                            rodentCount++;
                        }
                        // Number of crane and stork observations
                        else if ($.inArray(taxonID, storks) >= 0) {
                            storkCount++;
                        }
                        // Number of bugs observations
                        else if ($.inArray(taxonID, bugs) >= 0) {
                            bugCount++;
                        }
                        // Number of not-bugs observations
                        else if ($.inArray(taxonID, notBugs) >= 0 && $.inArray(taxonID, bugs) < 0) {
// TODO: count each type seperately
                            notBugCount++;
                        }
                        // Number of moss or lichen observations
                        else if ($.inArray(taxonID, mosses) >= 0) {
                            mossCount++;
                        }
                        // Number of toad observations
                        else if ($.inArray(taxonID, toads) >= 0) {
                            toadCount++;
                        }
                        // Number of mushroom observations
                        else if ($.inArray(taxonID, toadstools) >= 0) {
                            toadstoolCount++;
                        }
                        // Number of flowering plant orders
                        if (result.taxon.rank_level <= 40 
                                && $.inArray(taxonID, flowers) >= 0) {
                            if (!flowerOrderCount.includes(result.taxon.ancestor_ids[5])) {
                                flowerOrderCount.push(result.taxon.ancestor_ids[5]);
                            }
                        }
                    }
                    // Number of endangered observations
                    if (result.taxon.threatened === true) {
                        endangeredCount++;
                    }
                    // Daily Life
                    if (dailyLifeDate !== result.observed_on_details.date) {
                        dailyLifeDate = result.observed_on_details.date;
                        dailyObsCount = 0;
                        dailySpeciesCount = [];
                    }
                    if (dailyObsCountMax < ++dailyObsCount) {
                        dailyObsCountMax = dailyObsCount;
                    }
                    if (result.taxon.rank_level <= 10) {
// FIXME: Hierdie tel tien teen een ook subspecies
                        if (!dailySpeciesCount.includes(result.taxon.id)) {
                            dailySpeciesCount.push(result.taxon.id);
                        }
                    }
                    if (dailySpeciesCountMax < dailySpeciesCount.length) {
                        dailySpeciesCountMax = dailySpeciesCount.length;
                    }
                    // Longest active period (3 months without more than 3 days between observations)
                    var date1 = new Date(alwaysOnDate.substr(0, 4), alwaysOnDate.substr(5, 2), alwaysOnDate.substr(8, 2));
                    var date2 = new Date(result.observed_on_details.date.substr(0, 4), result.observed_on_details.date.substr(5, 2), result.observed_on_details.date.substr(8, 2));
                    if (Math.round(Math.abs(date1.getTime() - date2.getTime()) / alwaysOnOneDay) > 3) {
                        alwaysOnCount = 0;
                    }
                    if (alwaysOnDate !== result.observed_on_details.date) {
                        alwaysOnCount++;
                        alwaysOnDate = result.observed_on_details.date;
                    }
                    if (alwaysOnCountMax < alwaysOnCount) {
                        alwaysOnCountMax = alwaysOnCount;
                    }
                }
            }
            
            function showResults() {
                // Show the Achievements
                ReactDOM.render(
                        <div className="container">
                            <div className="row">
                                <AchievementCard title={"Life Lister (" + speciesCount + ")"} 
                                                 icon="icon-LifeLister" />
                                <AchievementCard title={"Self Polinator (" + selfCommentCount + ")"} 
                                                 icon="icon-SelfPolinator" />
                                <AchievementCard title={"Mammal Tryhard (" + mammalTryhardCount + ")"} 
                                                 icon="icon-TryMammals" />
                                <AchievementCard title={"Night Owl (" + nocturnalBirdCount + ")"} 
                                                 icon="icon-NightOwl" />
                                <AchievementCard title={"King Fisher (" + fishCount + ")"} 
                                                 icon="icon-KingFisher" />
                                <AchievementCard title={"Daisy Town (" + daisyCount + ")"} 
                                                 icon="icon-DaisyTown" />
                                <AchievementCard title={"Heart Of The Matter (" + endangeredCount + ")"} 
                                                 icon="icon-HeartOfTheMatter" />
                                <AchievementCard title={"Social Butterfly (" + butterflyCount + "," + socialCount + ")"} 
                                                 icon="icon-SocialButterfly" />
                                <AchievementCard title={"Group Therapy (" + projectCount.length + ")"} 
                                                 icon="icon-GroupTherapy" />
                                <AchievementCard title={"Name Giver (" + idCount + ")"} 
                                                 icon="icon-NameGiver" />
                                <AchievementCard title={"Daily Life (" + dailyObsCountMax + "," + dailySpeciesCountMax + ")"} 
                                                 icon="icon-DailyLife" />
                                <AchievementCard title={"Rat King (" + rodentCount + ")"} 
                                                 icon="icon-RatKing" />
                                <AchievementCard title={"Craney Storker (" + storkCount + ")"} 
                                                 icon="icon-CraneyStorker" />
                                <AchievementCard title={"So Many Bugs (" + bugCount + ")"} 
                                                 icon="icon-TooManyBugs" />
                                <AchievementCard title={"Not A Bug (" + notBugCount + ")"} 
                                                 icon="icon-NotABug" />
                                <AchievementCard title={"I Lichen Moss (" + mossCount + ")"} 
                                                 icon="icon-LickenMoss" />
                                <AchievementCard title={"Toads and Toadstools (" + toadCount + "," + toadstoolCount + ")"} 
                                                 icon="icon-ToadsAndToadstools" />
                                <AchievementCard title={"Flower Child (" + flowerOrderCount.length + ")"} 
                                                 icon="icon-FlowerChild" />
                                <AchievementCard title={"Classy Observer (" + classCount.length + ")"} 
                                                 icon="icon-WorldClass" />
                                <AchievementCard title={"Always On (" + alwaysOnCountMax + ")"} 
                                                 icon="icon-AlwaysOn" />
                            </div>
                        </div>,
                        document.getElementById('achievementList')
                );
            }
            
            // Load the user data
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.responseText);
                    idCount = data.results[0].identifications_count;
                    socialCount = data.results[0].activity_count;
                }
            };
            xhttp.open("GET", 
                        "https://api.inaturalist.org/v1/users/henrydelange", 
                        false); // "False" to indicate synchronous
            xhttp.send();
            console.log("Loaded user data");
            // Load the observation data
            var totalRecords = 0;
            xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
// TODO: Maak hierdie slimmer (dink nie dis nodig om die json te parse net vir die totaal nie)
                    var data = JSON.parse(this.responseText);
                    totalRecords = data.total_results;
                }
            };
            xhttp.open("GET", 
                        "https://api.inaturalist.org/v1/observations?user_id=henrydelange&per_page=1&page=1&order=desc&order_by=created_at", 
                        false); // "False" to indicate synchronous
            xhttp.send();
            console.log("Total Records = " + totalRecords);
// FIXME: Overwriting limit while busy doing development
totalRecords = 75;
            var perPage = 50;
            var page = 1; // Seems to start at 1, since 0 gives an error
            var allResponses = "";
// TODO: Find a way to throttle this to not exceed the iNat limit (around 60 requests per minute, 100 max)
            do {
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        processDataPage(this.responseText);
                    }
                };
                xhttp.open("GET", 
                            "https://api.inaturalist.org/v1/observations?user_id=henrydelange&per_page=" + perPage + "&page=" + page 
                                    + "&order=desc&order_by=observed_on", // Needs to be ordered by date to make some of the calculations easier
                            false); // "False" to indicate synchronous
                xhttp.send();
                console.log("Loaded Page " + page + " of " +  Math.floor(totalRecords / perPage));
                page++; // Move to the next page
            } while (page * perPage <= totalRecords);
            // Process the loaded data
// TODO: Later kan ek hierdie slimmer begin laai (async, en ook processing doen per page soos dit gelaai word in plaas van alles op die einde)
            console.log("Last page loaded, showing results...");
            showResults();
        </script>
        
        <!--Bootstrap - Must be near end of body-->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
                
<!--NOTE: When using ReactJS in Production-->
        <!--
          Note: this page is a great way to try React but it's not suitable for production.
          It slowly compiles JSX with Babel in the browser and uses a large development build of React.
    
          To set up a production-ready React build environment, follow these instructions:
          * https://reactjs.org/docs/add-react-to-a-new-app.html
          * https://reactjs.org/docs/add-react-to-an-existing-app.html
    
          You can also use React without JSX, in which case you can remove Babel:
          * https://reactjs.org/docs/react-without-jsx.html
          * https://reactjs.org/docs/cdn-links.html
        -->
    </body>
</html>
