<!DOCTYPE html>

<!-- TODO: Make the text multilingual -->

<html>
    <head>
        <meta charset="UTF-8" />
        <title>Wild Achievements</title>
        <!--ReactJS-->
        <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <!--Bootstrap-->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <!--Icons-->
        <link rel="stylesheet" href="./icons/style.css">
        <!--Custom CSS-->
        <link rel="stylesheet" href="./css/main.css">
    </head>
    <body>
        <!-- DECLARE MAIN UI -->
        <div class="row">
            <div class="col">
                <div class="jumbotron jumbotron-fluid">
                    <div class="container">
                        <h1 class="display-4">Wild Achievements</h1>
                        <p class="lead">Upload observation on iNaturalist.org to try and unlock all achievements!</p>
                        <a tabindex="0" class="btn btn-sm btn-secondary float-right" role="button" 
                           data-toggle="popover" data-trigger="focus" data-html="true"
                           title="Available URL Parameters" 
                           data-content="<li>'user=username' <br /> 
                                            Immediately load the achievements for the specified user.</li>
                                        <li>'limit=100' <br /> 
                                            Limit the number of observations that are read.</li>">
                            URL Parameters
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div className="container">
            <div class="row">
                <div class="input-group mb-3 w-50 mx-auto input-group-lg">
                    <input id="username" type="text" class="form-control" placeholder="iNaturalist Username" 
                            aria-label="Username" aria-describedby="inputGroup-sizing-lg">
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary" type="button" 
                                onclick="document.getElementById('PanelAchievements').style.display = '';
                                         document.getElementById('PanelLoading').style.display = '';
                                         setTimeout(loadUserData, 10);">
                            Calculate Achievements
                        </button>
                    </div>
                </div>
            </div>
        </div>
<!-- TODO: This showing / hiding does not feel nice, think of a better way. Also consider making the main UI also be React components... -->
        <div id="PanelFeedback" style="display: none" class="alert alert-warning w-50 mx-auto" role="alert"></div>
        <hr />
        <!-- Hide these components until a username has been provided to use -->
        <div id="PanelAchievements" style="display: none">
            <div id="PanelLoading">
                <div className="container">
                    <div class="row">
                        <div class="progress w-50 mx-auto" style="height: 30px">
                            <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuenow="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="row" style="margin: 1rem">
                        <div class="alert alert-primary w-25 mx-auto" role="alert" id="progressDetails">
                            Fetching data...
                        </div>
                    </div>
                </div>
                <hr />
            </div>
            <div id="achievementList"></div>
            <hr />
        </div>
        <!-- DECLARE ACHIEVEMENTS -->
        <script type="text/babel" src="./js/AchievementCardData.js"></script>
        <script type="text/babel" src="./js/AchievementImplementations.js"></script>
        <!-- DECLARE REACTJS COMPONENTS -->
        <script type="text/babel" src="./js/AchievementCard.jsx"></script>
        <script type="text/babel" src="./js/ShowAchievements.jsx"></script>
        <!-- SETUP BOOTSTRAP -->
        <script type="text/babel">
            $(function () {
                $('[data-toggle="popover"]').popover()
            });
            $('.popover-dismiss').popover({
                trigger: 'focus'
            });
        </script>
        <!-- PROCESS THE DATA -->
        <script type="text/babel">
            // The active user name
            var activeUserName = "";
            var readLimit = 500;
            
            // Load the user's data
            function loadUserData() {
                var feedback = document.getElementById('PanelFeedback');
// TODO: Don't do subsequent button presses while the first press is still busy processing?
                activeUserName = document.getElementById('username').value;
                if (!activeUserName) {
                    feedback.innerHTML = 'Please provide an iNaturalist username.';
                    feedback.style.display = '';
                    document.getElementById('PanelLoading').style.display = 'none';
                    document.getElementById('PanelAchievements').style.display = 'none';
                    return;
                }
                else {
                    feedback.innerHTML = '';
                    feedback.style.display = 'none';
                }
                // Clear the old global state variables
                clearGlobalState()
                // Setup the list of achievements
                setupAchievementsList();
                // Load the user data
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = JSON.parse(this.responseText);
                        idCount = data.results[0].identifications_count;
                        socialCount = data.results[0].activity_count;
                    }
                };
                xhttp.open("GET", 
                            "https://api.inaturalist.org/v1/users/" + activeUserName, 
                            false); // "False" to indicate synchronous
                xhttp.send();
                console.log("Loaded user data");
                // Load the observation data
                var totalRecords = 0;
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = JSON.parse(this.responseText);
                        totalRecords = data.total_results;
                    }
                };
                xhttp.open("GET", 
                            "https://api.inaturalist.org/v1/observations?user_id=" + activeUserName 
                                    + "&per_page=1&page=1&order=desc&order_by=created_at", 
                            false); // "False" to indicate synchronous
                xhttp.send();
                console.log("Total Records = " + totalRecords);
                if (totalRecords === 0) {
                    feedback.innerHTML = 'No observations were found for the provided username.';
                    feedback.style.display = '';
                    document.getElementById('PanelLoading').style.display = 'none';
                    document.getElementById('PanelAchievements').style.display = 'none';
                    return;
                }
                else {
                    feedback.innerHTML = '';
                    feedback.style.display = 'none';
                }
                // NOTE: Stopping processing after 2000 (default) records to prevent too many unneccessary calls to the iNat servers...
                if (totalRecords > readLimit) {
                    totalRecords = readLimit;
                    feedback.innerHTML = 'Only the ' + readLimit + ' most recent observations were used.';
                    feedback.style.display = '';
                }
                else {
                    feedback.innerHTML = '';
                    feedback.style.display = 'none';
                }
                var perPage = 50;
                var page = 0; // NOTE: The first page seems to start at 1 (0 gives an error), so increase the page before the first load

// TODO: Find a way to throttle this to not exceed the iNat limit (around 60 requests per minute, 100 max)
// TODO: Maybe improve this to load the data async and show updated achievements as the processing progresses?
// FIXME: Progress bar doesn't seem to work anymore after recent code changes... And the feedback only updates after the function completes... Make it be more async...

                var pagesToRead = Math.ceil(totalRecords / perPage);
                do {
                    page++; // Move to the next page
                    xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            processDataPage(this.responseText, page, perPage, totalRecords);
                        }
                    };
                    xhttp.open("GET", 
                                "https://api.inaturalist.org/v1/observations?user_id=" + activeUserName 
                                        + "&per_page=" + perPage + "&page=" + page 
                                        + "&order=desc&order_by=observed_on", // Needs to be ordered by date to make some of the calculations easier
                                false); // "False" to indicate synchronous
                    xhttp.send();
                    console.log("Loaded Page " + page + " of " + pagesToRead);
                } 
                while (page < pagesToRead);
                // Process the loaded data
                console.log("Last page loaded, showing results...");
                // Update progress bar
                $('.progress-bar').css("width", '100%').attr("aria-valuenow", '100%').text('100%');
                $('#progressDetails').text("Done :)");
                // Hide the loading progress bar
                setTimeout(() => {document.getElementById('PanelLoading').style.display = 'none'}, 3000);
                // Show the achievements
                showAchievements();
            }
            
            // Process a page of data that has been fetched from iNaturalist
            function processDataPage(response, page, perPage, totalRecords) {
                // Process data
                var data = JSON.parse(response);
                var arrayLength = data.results.length;
                // LOOP OVER OBSERVATIONS
                for (var i = 0; i < arrayLength && (((page - 1) * perPage) + i ) < totalRecords; i++) {
                    var result = data.results[i];
                    // Give each achievement a chance to evaluate for the iNat observation
                    for (var t = 0; t < lstAchievementCardWrappers.length; t++) {
                        lstAchievementCardWrappers[t].evaluate(result);
                    }
                    // Update progress bar
                    var percentVal = (((page - 1) * perPage) + i) / totalRecords * 100;
                    setTimeout(setProgress(percentVal), 0); // Makes the function run asynchronously
                }
            }
            
            // Update the progres bar
            function setProgress(percentVal) {
                $('.progress-bar').css("width", percentVal+ '%').attr("aria-valuenow", percentVal+ '%').text(percentVal+ '%');
                $('#progressDetails').text("Fetching more data...");
            }
            
            // START MAIN PROCESSING
            // If the URL parameter was present then handle it imediately
            var url = new URL(window.location.href);
            var limitParam = url.searchParams.get("limit");
            if (limitParam) {
                readLimit = limitParam;
            }
            var userParam = url.searchParams.get("user");
            if (userParam) {
                console.log("URL parameter found..." );
                activeUserName = userParam;
                document.getElementById('username').value = activeUserName;
                document.getElementById('PanelAchievements').style.display = '';
                setTimeout(loadUserData, 0); // Makes the function run asynchronously
            }
        </script>
        
        <!--Bootstrap - Must be near end of body-->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
                
        <!--NOTE: ReactJS in Production-->
        <!--
          Note: this page is a great way to try React but it's not suitable for production.
          It slowly compiles JSX with Babel in the browser and uses a large development build of React.
    
          To set up a production-ready React build environment, follow these instructions:
          * https://reactjs.org/docs/add-react-to-a-new-app.html
          * https://reactjs.org/docs/add-react-to-an-existing-app.html
    
          You can also use React without JSX, in which case you can remove Babel:
          * https://reactjs.org/docs/react-without-jsx.html
          * https://reactjs.org/docs/cdn-links.html
        -->
    </body>
</html>
